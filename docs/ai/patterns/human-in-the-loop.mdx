---
title: "Resilient human-in-the-loop steps"
sidebarTitle: "Human-in-the-loop"
description: "Build resilient human approval steps in your agent workflows."
tags: ["recipe"]
---


Build resilient workflows that include human approval steps or external signals without worrying about failures or interruptions.

Sometimes you need to include a human evaluator, approval step, or another external signal in an agentic workflow. In a simple standalone app, you could model this by awaiting a promise/future that gets completed via a callback. Luckily, Durable Execution allows us to do the exact same thing, without worrying about failures or interruptions.


## How does Restate help?
The benefits of using Restate here are:
- **Durable promises**: Create promises that survive process restarts and failures
- **Automatic recovery**: Resume exactly where you left off after any interruption
- Works with **any AI SDK** (OpenAI, LangChain, Pydantic AI, LiteLLM, etc.) and **any programming language** supported by Restate (TypeScript, Python, Go, etc.)
- **Cost-efficient waiting**: Suspend execution during approval wait times - pay for active work, not idle time:
<img src="/img/ai/patterns/human_approval_typescript.gif"/>

## Example

Use `ctx.awakeable()` to create durable promises that can be resolved externally. The workflow suspends during the wait and resumes automatically when the promise is resolved.


```python
@content_moderator_svc.handler()
async def moderate(ctx: restate.Context, content: Content) -> str | None:
    """Moderate content with human-in-the-loop review"""

    # Durable step for LLM inference, auto retried & recovered
    result = await ctx.run_typed(
        "moderate",
        llm_call,
        RunOptions(max_attempts=3),
        prompt=f"Decide whether content violates the policy."
        f"Use the human review tool if you are not sure."
        f"Content: {content}",
        tools=[tool(name="get_human_review", description="Get human review for content that may violate policy.")],
    )

    # request human review, if ordered by LLM
    if result.tool_calls and result.tool_calls[0].function.name == "get_human_review":
        # Create a durable promise (awakeable),
        approval_id, approval_promise = ctx.awakeable(type_hint=str)

        # Notify moderator, identify the durable promise by its id
        await ctx.run_typed(
            "notify_moderator",
            notify_moderator,
            content=content,
            approval_id=approval_id,
        )

        # Pause for completion of the promise.
        # The workflow suspends here and resumes after the promise resolution.
        # Check the service logs to see how to resolve it, e.g.:
        # curl http://localhost:8080/restate/awakeables/sign_.../resolve --json '"approved"'
        return await approval_promise

    return result.content
```

<Tip>
    This pattern is implementable with any of our SDKs and any AI SDK.
    If you need help with a specific SDK, please reach out to us via [Discord](https://discord.com/invite/skW3AZ6uGd) or [Slack](https://join.slack.com/t/restatecommunity/shared_invite/zt-2v9gl005c-WBpr167o5XJZI1l7HWKImA).
</Tip>


## Running the example

<Steps>
    <StartExample/>
<Step title="Send a request">

    In the UI (`http://localhost:9070`), click on the `moderate` handler of the `ContentModerator` to open the playground and send a request with content that requires human review.

    Or use `curl` to send a request directly to the service:

    ```shell
    curl -X POST http://localhost:8080/ContentModerator/moderate \
      --json '{"content": "This content might need human review to determine if it violates our policy."}'
    ```

</Step>

<Step title="Resolve the approval">

    When the LLM requests human review, check the service logs to find the awakeable ID, then resolve it:

    ```shell
    curl http://localhost:8080/restate/awakeables/{awakeable_id}/resolve --json '"approved"'
    ```

    Replace `{awakeable_id}` with the actual ID from the logs.

</Step>

<Step title="Check the Restate UI">

    You can see in the Invocations Tab of the UI how the workflow suspends during the human approval step and resumes once the promise is resolved.

</Step>
</Steps>